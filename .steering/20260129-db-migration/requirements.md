# 要求内容

## 概要

.sqlファイルを実行してデータベースに反映するマイグレーション機能を実装します。マイグレーションファイルは`./migrations`ディレクトリに格納されたものを対象とします。

## 背景

現在のKey Management Serviceでは、データベーススキーマは手動で管理されており、`migrations/001_create_encryption_keys.sql`のようなマイグレーションファイルが存在しますが、これらを自動的に実行する機能がありません。本番環境やステージング環境へのデプロイ時に、マイグレーションを確実かつ冪等的に適用するための仕組みが必要です。

## 実装対象の機能

### 1. マイグレーション実行機能
- `./migrations`ディレクトリ内の.sqlファイルを検出し、番号順に実行
- 既に適用済みのマイグレーションはスキップ（冪等性）
- マイグレーションの適用履歴をデータベースに記録
- エラーが発生した場合は適切にハンドリング

### 2. マイグレーションステータス確認機能
- 現在のマイグレーション適用状況を確認
- 未適用のマイグレーションファイルを一覧表示
- 適用済みマイグレーションの履歴を表示

### 3. CLI統合
- `keyctl migrate up` - マイグレーションを実行
- `keyctl migrate status` - マイグレーションステータスを表示

## 受け入れ条件

### マイグレーション実行機能
- [ ] `./migrations`ディレクトリ内の.sqlファイルを検出できる
- [ ] ファイル名の番号順（例: 001_, 002_）にマイグレーションを実行できる
- [ ] 既に適用済みのマイグレーションはスキップされる
- [ ] マイグレーション適用履歴が`schema_migrations`テーブルに記録される
- [ ] エラーが発生した場合、適切なエラーメッセージを出力し、処理を中断する
- [ ] トランザクション内でマイグレーションを実行し、失敗時はロールバックする

### マイグレーションステータス確認機能
- [ ] 適用済みマイグレーションの一覧を表示できる
- [ ] 未適用マイグレーションの一覧を表示できる
- [ ] 各マイグレーションの適用日時を表示できる

### CLI統合
- [ ] `keyctl migrate up`コマンドが正常に動作する
- [ ] `keyctl migrate status`コマンドが正常に動作する
- [ ] コマンド実行時にデータベース接続情報を環境変数から取得する
- [ ] エラー発生時に適切なexitコードを返す

## 成功指標

- マイグレーション機能が動作し、手動でのSQL実行が不要になる
- デプロイ時のマイグレーション適用が自動化される
- マイグレーション履歴がデータベースで管理され、冪等性が保証される

## スコープ外

以下はこのフェーズでは実装しません:

- マイグレーションのロールバック機能（down migration）
- マイグレーションファイルの自動生成機能
- マイグレーションのドライラン（dry-run）機能
- 複数データベースへの同時マイグレーション

## 参照ドキュメント

- `docs/repository-structure.md` - リポジトリ構造定義書
- `docs/development-guidelines.md` - 開発ガイドライン
- `key-management-service/migrations/001_create_encryption_keys.sql` - 既存のマイグレーションファイル
