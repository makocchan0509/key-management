# 要求内容

## 概要

暗号鍵管理サービス（Key Management Service）のMVP（Minimum Viable Product）を実装する。REST APIサーバーとCLIツールの両方を提供し、テナントごとの暗号鍵の生成・取得・ローテーション・一覧取得・無効化機能を実現する。

## 背景

クライアントシステムが個別に暗号鍵を生成・管理する負担を軽減し、セキュアな鍵管理を一元化するサービスが必要。PCI-DSS準拠の監査ログ出力と、Cloud KMSを使用したエンベロープ暗号化パターンによりセキュリティ要件を満たす。

## 実装対象の機能

### 1. 鍵の生成
- テナントIDを指定してAES-256鍵を生成
- 世代番号1として登録
- Cloud KMSのKEKで暗号化してCloud SQLに保存

### 2. 鍵の取得
- テナントIDを指定して現在有効な（最新世代の）鍵を取得
- テナントIDと世代番号を指定して特定世代の鍵を取得
- 無効化された鍵はエラーを返す

### 3. 鍵のローテーション
- テナントIDを指定して新しい世代の鍵を生成
- 現在の最大世代番号+1として登録
- 過去世代の鍵は引き続き取得可能

### 4. 鍵一覧の取得
- テナントIDを指定して全世代の鍵メタデータを取得
- メタデータには世代番号、作成日時、ステータスを含む
- 鍵の平文は含まない

### 5. 鍵の無効化（論理削除）
- テナントIDと世代番号を指定して特定世代の鍵を無効化
- ステータスを「disabled」に変更
- 物理削除はしない

### 6. REST API
- POST /v1/tenants/{tenant_id}/keys（生成）
- GET /v1/tenants/{tenant_id}/keys/current（現在鍵取得）
- GET /v1/tenants/{tenant_id}/keys/{generation}（世代指定取得）
- POST /v1/tenants/{tenant_id}/keys/rotate（ローテーション）
- GET /v1/tenants/{tenant_id}/keys（一覧取得）
- DELETE /v1/tenants/{tenant_id}/keys/{generation}（無効化）

### 7. CLI (keyctl)
- keyctl create --tenant <tenant_id>
- keyctl get --tenant <tenant_id>
- keyctl get --tenant <tenant_id> --generation <generation>
- keyctl rotate --tenant <tenant_id>
- keyctl list --tenant <tenant_id>
- keyctl disable --tenant <tenant_id> --generation <generation>

### 8. 監査ログ
- 全ての鍵操作を構造化ロギング形式で出力
- 操作種別、テナントID、世代番号、タイムスタンプ、結果を記録

## 受け入れ条件

### 鍵の生成
- [ ] テナントIDを指定してAES-256鍵を生成できる
- [ ] 生成された鍵は世代番号1として登録される
- [ ] 鍵はCloud KMSのKEKで暗号化されて保存される
- [ ] 既に鍵が存在するテナントに対してはエラーを返す
- [ ] 生成操作は監査ログに記録される

### 鍵の取得
- [ ] テナントIDを指定して現在有効な鍵を取得できる
- [ ] テナントIDと世代番号を指定して特定世代の鍵を取得できる
- [ ] 無効化された鍵は取得できずエラーを返す
- [ ] 存在しないテナント/世代はエラーを返す
- [ ] 取得操作は監査ログに記録される

### 鍵のローテーション
- [ ] テナントIDを指定して新しい世代の鍵を生成できる
- [ ] 新しい鍵は現在の最大世代番号+1として登録される
- [ ] 過去世代の鍵は引き続き取得可能
- [ ] 存在しないテナントに対してはエラーを返す
- [ ] ローテーション操作は監査ログに記録される

### 鍵一覧の取得
- [ ] テナントIDを指定して全世代の鍵メタデータを取得できる
- [ ] メタデータには世代番号、作成日時、ステータスが含まれる
- [ ] 鍵の平文は含まれない
- [ ] 存在しないテナントは空のリストを返す

### 鍵の無効化
- [ ] テナントIDと世代番号を指定して鍵を無効化できる
- [ ] 無効化された鍵は取得APIで取得できなくなる
- [ ] 存在しないテナント/世代はエラーを返す
- [ ] 既に無効化されている鍵は再度無効化できずエラーを返す
- [ ] 無効化操作は監査ログに記録される

### CLI
- [ ] 全コマンドが正常に動作する
- [ ] --output json オプションでJSON形式の出力ができる
- [ ] エラー時は適切な終了コードを返す
- [ ] --help でヘルプが表示される

## 成功指標

- APIレスポンス時間: 1000ms以内（p99）
- CLIコマンド応答時間: 2000ms以内
- ユニットテストカバレッジ: 80%以上

## スコープ外

以下はこのフェーズでは実装しません:

- 暗号化/復号処理（クライアントの責務）
- 認証・認可機能（Google Cloud IAMに委譲）
- 自動ローテーション
- マルチリージョン対応
- HSM連携
- 鍵の物理削除
- 鍵の有効期限設定
- OpenTelemetryによる分散トレーシング（Post-MVPで実装）

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/architecture.md` - アーキテクチャ設計書
- `docs/repository-structure.md` - リポジトリ構造定義書
- `docs/development-guidelines.md` - 開発ガイドライン
