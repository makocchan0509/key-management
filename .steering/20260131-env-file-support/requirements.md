# 要求定義: .envファイルサポート

## 概要

ローカル開発環境での動作確認を容易にするため、環境変数を`.env`ファイルから読み込めるようにする。`.env`ファイルが存在しない場合は、従来通り環境変数から直接読み込む動作を維持する。

## 背景

現在の環境変数の読み込み:
- `config/config.go`の`Load()`関数で`os.Getenv()`を使用
- 環境変数は実行前に手動で設定する必要がある
- ローカル開発時に複数の環境変数を毎回exportするのが煩雑

期待する改善:
- `.env`ファイルに環境変数を定義できる
- ファイルが存在すれば自動的に読み込む
- ファイルが存在しなければ従来通り動作（本番環境での互換性維持）

## 要求内容

### 1. .envファイル読み込み機能

**必須要件**:
- `.env`ファイルから環境変数を読み込む機能を追加
- `.env`ファイルが存在しない場合はエラーにせず、通常の環境変数読み込みを実行
- 既存の環境変数が設定されている場合は、環境変数を優先（`.env`で上書きしない）
- ファイル読み込みはアプリケーション起動時の最初期（`config.Load()`実行前）に実行

**対象となる環境変数**:
- `PORT` (デフォルト: 8080)
- `DATABASE_URL` (必須)
- `KMS_KEY_NAME` (必須)
- `GOOGLE_CLOUD_PROJECT` (必須)
- `LOG_LEVEL` (デフォルト: INFO)

### 2. .envファイルの配置場所

**配置場所**:
- プロジェクトルート（`key-management-service/`）直下に`.env`ファイルを配置
- 実行時のカレントディレクトリから`.env`を探す

### 3. .envファイルのフォーマット

**フォーマット**:
```
# データベース接続
DATABASE_URL=user:password@tcp(localhost:3306)/keymanagement?parseTime=true

# Google Cloud設定
GOOGLE_CLOUD_PROJECT=my-project
KMS_KEY_NAME=projects/my-project/locations/global/keyRings/my-keyring/cryptoKeys/my-key

# サーバー設定
PORT=8080
LOG_LEVEL=DEBUG
```

**仕様**:
- `KEY=VALUE`形式
- `#`で始まる行はコメント
- 空行は無視
- 値にスペースや特殊文字を含む場合はクォート不要（そのまま読み込む）

### 4. gitignore対応

**要件**:
- `.env`ファイルを`.gitignore`に追加（機密情報を含むため）
- `.env.example`ファイルをサンプルとして提供（値は空またはダミー）

### 5. 後方互換性

**重要**:
- `.env`ファイルが存在しない環境（本番環境、CI/CD環境など）でも従来通り動作すること
- 既存の環境変数設定方法を破壊しない
- 環境変数が既に設定されている場合、`.env`の値で上書きしない

## 非機能要件

### セキュリティ

- `.env`ファイルにDATABASE_URLなどの機密情報が含まれるため、Gitにコミットしないこと
- `.env.example`には実際の値を含めず、フォーマットのみを示すこと

### パフォーマンス

- `.env`読み込みはアプリケーション起動時の1回のみ
- ファイル存在チェックで遅延が発生しないこと

### 保守性

- 使用するライブラリは標準的なもの（`godotenv`など）を採用
- ライブラリのメンテナンス状況を確認すること

## 成功基準

### 機能的成功基準

1. `.env`ファイルが存在する場合、環境変数が正しく読み込まれる
2. `.env`ファイルが存在しない場合、エラーが発生せずに起動する
3. 環境変数が既に設定されている場合、`.env`の値よりも環境変数が優先される
4. `.env.example`が提供され、開発者がすぐに使い始められる

### 非機能的成功基準

1. `.env`が`.gitignore`に追加され、Gitにコミットされない
2. 既存のテストがすべてパスする
3. `golangci-lint`によるlintチェックがパスする
4. 本番環境（Cloud Run）での動作に影響しない

## 実装範囲外

以下は今回の実装範囲外とする:

- 複数の`.env`ファイル対応（`.env.local`, `.env.production`など）
- 環境変数の暗号化
- `.env`ファイルの動的リロード
- 環境変数のバリデーション強化（既存のバリデーションロジックは維持）

## 参考情報

### 使用予定のライブラリ

- `github.com/joho/godotenv` - Go標準的な.envファイルローダー
  - 広く使われている（GitHub stars: 8k+）
  - シンプルなAPI
  - 後方互換性のサポート（ファイル存在チェック）

### 類似実装パターン

他のGoプロジェクトでの一般的なパターン:
```go
import "github.com/joho/godotenv"

func init() {
    // .envファイルが存在すれば読み込む（存在しなくてもエラーにしない）
    _ = godotenv.Load()
}
```
