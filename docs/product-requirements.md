# プロダクト要求定義書 (Product Requirements Document)

## プロダクト概要

### 名称

**暗号鍵管理サービス（Key Management Service）**

### プロダクトコンセプト

- **鍵管理の集約**: クライアントシステムが自身で暗号鍵を生成・保管する必要がなくなる
- **世代管理**: 顧客（テナント）ごとに鍵を世代管理し、ローテーションと過去鍵の参照が可能
- **エンベロープ暗号化**: 保管する暗号鍵（DEK）はCloud KMSの鍵暗号鍵（KEK）で暗号化して保護
- **PCI-DSS準拠**: 暗号鍵管理に関する要件はPCI-DSS v4.0以上に準拠

### プロダクトビジョン

クライアントシステムが暗号鍵の生成・保管・ローテーションの負担から解放され、セキュアな鍵管理を簡単に利用できる世界を実現する。REST APIとCLIの両方を提供し、アプリケーション連携からシェルスクリプトによる運用作業まで幅広いユースケースに対応する。

### 目的

- 顧客（テナント）ごとのAES-256暗号鍵の生成と世代別保管を提供する
- REST APIによるプログラマティックなアクセスを可能にする
- CLIによるシェルスクリプト・運用作業での利用を可能にする
- PCI-DSS準拠の監査ログを出力する

## ターゲットユーザー

### クライアントの特定

- **社内マイクロサービス**: 約10個のアプリケーションが本サービスを利用
- **利用者（エンドユーザー）**: 複数の顧客企業（テナント）

### クライアントの課題

- 各マイクロサービスが個別に暗号鍵を生成・管理する負担が大きい
- 鍵のローテーション時に、古いデータの復号のため過去世代の鍵も必要
- PCI-DSS準拠のための監査ログ要件を各サービスで実装するのは非効率

### クライアントの期待する解決策

- 暗号鍵の生成・保管・取得を一元化されたAPIで利用できる
- 顧客ごとの鍵世代管理により、ローテーションと過去鍵参照が容易になる
- 監査ログが自動的に出力され、コンプライアンス対応が簡素化される

## 機能要件

### コア機能(MVP)

#### 鍵の生成

**ユーザーストーリー**:
クライアントシステムとして、顧客のデータを暗号化するために、顧客に紐づく新しい暗号鍵を生成したい

**受け入れ条件**:
- [ ] 顧客ID（テナントID）を指定してAES-256鍵を生成できる
- [ ] 生成された鍵は世代番号1として登録される
- [ ] 鍵はCloud KMSのKEKで暗号化されてCloud SQLに保存される
- [ ] 既に鍵が存在する顧客IDに対して生成を試みた場合、エラーを返す
- [ ] 生成操作は監査ログに記録される

**優先度**: P0(必須)

#### 鍵の取得

**ユーザーストーリー**:
クライアントシステムとして、データの暗号化または復号を行うために、顧客の暗号鍵を取得したい

**受け入れ条件**:
- [ ] 顧客IDを指定して現在有効な（最新世代の）鍵を取得できる
- [ ] 顧客IDと世代番号を指定して特定世代の鍵を取得できる
- [ ] 無効化（論理削除）された鍵は取得できず、エラーを返す
- [ ] 存在しない顧客IDまたは世代番号を指定した場合、エラーを返す
- [ ] 取得操作は監査ログに記録される

**優先度**: P0(必須)

#### 鍵のローテーション

**ユーザーストーリー**:
クライアントシステムとして、セキュリティ向上のために、顧客の暗号鍵を新しい世代に更新したい

**受け入れ条件**:
- [ ] 顧客IDを指定して新しい世代の鍵を生成できる
- [ ] 新しい鍵は現在の最大世代番号+1として登録される
- [ ] 過去世代の鍵は引き続き取得可能（復号用途）
- [ ] 存在しない顧客IDに対してローテーションを試みた場合、エラーを返す
- [ ] ローテーション操作は監査ログに記録される

**優先度**: P0(必須)

#### 鍵一覧の取得

**ユーザーストーリー**:
クライアントシステムとして、顧客の鍵管理状況を把握するために、鍵の世代一覧を取得したい

**受け入れ条件**:
- [ ] 顧客IDを指定して、その顧客の全世代の鍵メタデータを取得できる
- [ ] メタデータには世代番号、作成日時、ステータスが含まれる
- [ ] 鍵の実データ（平文）は含まれない
- [ ] 存在しない顧客IDを指定した場合、空のリストを返す

**優先度**: P0(必須)

#### 鍵の無効化（論理削除）

**ユーザーストーリー**:
クライアントシステムとして、鍵漏洩などのセキュリティインシデント発生時に、該当する鍵を即座に利用停止したい

**受け入れ条件**:
- [ ] 顧客IDと世代番号を指定して特定世代の鍵を無効化できる
- [ ] 無効化された鍵は取得APIで取得できなくなる
- [ ] 無効化された鍵のステータスは「disabled」となる
- [ ] 無効化は論理削除であり、データベースから物理削除されない
- [ ] 存在しない顧客IDまたは世代番号を指定した場合、エラーを返す
- [ ] 既に無効化されている鍵を再度無効化しようとした場合、エラーを返す
- [ ] 無効化操作は監査ログに記録される

**優先度**: P0(必須)

### REST APIインターフェース

```
# 鍵の生成
POST /v1/tenants/{tenant_id}/keys
Response: 201 Created

# 現在有効な鍵の取得
GET /v1/tenants/{tenant_id}/keys/current
Response: 200 OK { "key": "base64encoded...", "generation": 3 }

# 特定世代の鍵の取得
GET /v1/tenants/{tenant_id}/keys/{generation}
Response: 200 OK { "key": "base64encoded...", "generation": 1 }

# 鍵のローテーション
POST /v1/tenants/{tenant_id}/keys/rotate
Response: 201 Created { "generation": 4 }

# 鍵一覧の取得
GET /v1/tenants/{tenant_id}/keys
Response: 200 OK { "keys": [{ "generation": 1, "created_at": "...", "status": "active" }, ...] }

# 鍵の無効化（論理削除）
DELETE /v1/tenants/{tenant_id}/keys/{generation}
Response: 202 Accepted
```

### CLIインターフェース

```bash
# 鍵の生成
keyctl create --tenant <tenant_id>

# 現在有効な鍵の取得
keyctl get --tenant <tenant_id>

# 特定世代の鍵の取得
keyctl get --tenant <tenant_id> --generation <generation>

# 鍵のローテーション
keyctl rotate --tenant <tenant_id>

# 鍵一覧の取得
keyctl list --tenant <tenant_id>

# 鍵の無効化（論理削除）
keyctl disable --tenant <tenant_id> --generation <generation>
```

### 将来的な機能(Post-MVP)

#### 鍵の物理削除

無効化された鍵をデータベースから完全に削除する機能

**優先度**: P2(できれば)

#### 鍵の有効期限設定

鍵に有効期限を設定し、期限切れ時に自動的にステータスを変更する機能

**優先度**: P2(できれば)

## 非機能要件

### パフォーマンス

- APIレスポンス時間: 1000ms以内（p99）
- CLIコマンド応答時間: 2000ms以内（ネットワーク遅延含む）

### ユーザビリティ

- REST APIはOpenAPI仕様書を提供し、インターフェースを明確に把握できる
- CLIは`--help`オプションで全コマンドと使用方法を確認できる
- エラーレスポンスには原因と対処方法を含める

### 信頼性

- Cloud SQLの障害時はエラーを返し、データ不整合を防ぐ
- トランザクション内でのエラー発生時はロールバックする

### セキュリティ

- DEKはCloud KMSのKEKで暗号化した状態でのみ保存する
- 鍵の平文がログに出力されないようにする
- 認証・認可はGoogle Cloud IAMで実現（本サービスでは実装しない）

### スケーラビリティ

- Cloud Runの自動スケーリングにより、リクエスト増加に対応
- Cloud SQLのコネクションプール管理を適切に行う

### 監査ログ

- 全ての鍵操作（生成、取得、ローテーション、一覧取得、無効化）を記録
- Google Cloud構造化ロギング形式で標準出力に出力
- 記録項目: 操作種別、顧客ID、世代番号、タイムスタンプ、結果（成功/失敗）

## スコープ外

明示的にスコープ外とする項目:

- **暗号化/復号処理**: 本サービスは鍵の管理のみを行い、実際のデータ暗号化/復号はクライアントの責務
- **認証・認可機能**: Google Cloud IAMに委譲し、本サービスでは実装しない
- **自動ローテーション**: 定期的な自動ローテーション機能は提供しない（クライアントの任意タイミングで実行）
- **マルチリージョン対応**: 単一リージョンでの運用を前提とする
- **HSM連携**: Cloud KMSの標準機能のみを使用し、HSMは利用しない
