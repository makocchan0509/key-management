# 暗号鍵管理マイクロサービス - 初期要件

## 概要

データベース内の機密データおよびファイルの暗号化に使用する暗号鍵を管理するマイクロサービス。

## ユースケース

- **暗号化対象**: データベース内の機密データ、ファイル
- **利用クライアント**: 約10個のアプリケーション
- **利用者**: 複数の顧客企業（テナント）

## 暗号化方式

### エンベロープ暗号化パターン

```
┌─────────────────────────────────────────────────────────┐
│                    Cloud KMS                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │  KEK (Key Encryption Key)                       │   │
│  │  - マスターキー                                  │   │
│  │  - DEKの暗号化/復号に使用                        │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│              鍵管理マイクロサービス                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │  DEK (Data Encryption Key)                      │   │
│  │  - 顧客ごとに管理                                │   │
│  │  - 世代（バージョン）管理                         │   │
│  │  - 暗号化された状態でCloud SQLに保存              │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 クライアント                             │
│  - DEKを取得して暗号化/復号を実行                        │
│  - 暗号化/復号の責務はクライアント側                      │
└─────────────────────────────────────────────────────────┘
```

### 暗号アルゴリズム

- **方式**: AES（対称鍵暗号）
- **鍵長**: AES-256（256ビット）
- **実装言語**: Go

## 鍵のライフサイクル管理

### 世代管理

- 顧客（テナント）ごとに鍵を管理
- 各顧客の鍵は世代（バージョン）で管理
- 顧客の任意タイミングで鍵のローテーション（新世代作成）が可能
- 過去の世代の鍵も取得可能（古いデータの復号のため）

### 鍵の状態

```
生成 → 有効 → ローテーション → 旧世代（復号のみ利用可能）
```

## インターフェース

### REST API

鍵管理操作を提供するREST API：

| 操作 | 説明 |
|------|------|
| 鍵の生成 | 顧客に対して新しいDEKを生成 |
| 鍵の取得 | 指定した顧客・世代のDEKを取得 |
| 鍵のローテーション | 新しい世代のDEKを生成 |
| 鍵一覧の取得 | 顧客の鍵世代一覧を取得 |

### CLI

REST APIをラップしたコマンドラインツール：

- シェルスクリプトからの利用を想定
- 運用作業やバッチ処理での利用

## インフラ構成

| コンポーネント | サービス |
|---------------|---------|
| アプリケーション実行環境 | Cloud Run |
| 鍵暗号化（KEK） | Cloud KMS |
| 鍵保存（暗号化済みDEK） | Cloud SQL |
| ログ出力先 | Cloud Logging |

## 認証・認可

- Google Cloudの仕組み（IAM等）で実現
- マイクロサービスとしての認証・認可機能は実装しない

## 監査ログ

- **出力先**: 標準出力 / 標準エラー出力
- **フォーマット**: Google Cloud構造化ロギング形式
- **記録対象**: 鍵へのアクセス操作（PCI-DSS準拠のため）

## コンプライアンス

- **準拠規格**: PCI-DSS
- **HSM**: 不要

## 環境分離

- 開発/ステージング/本番環境はマイクロサービス自体を分離してデプロイ
- 実装上の環境分離考慮は不要

## 未決定事項

- [ ] API認証の具体的な方式（Cloud Run側の設定）
- [ ] Cloud SQLのインスタンス構成（共有/専用）
- [ ] バックアップ・リカバリ要件
- [ ] SLA要件（可用性、レイテンシ）
- [ ] 鍵の削除ポリシー（論理削除/物理削除）
