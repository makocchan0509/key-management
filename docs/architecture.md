# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン | 選定理由 |
|------|-----------|----------|
| Go | 1.23.x | PRDで指定。Cloud Runとの親和性が高く、静的型付けによる安全性、高速なコンパイル、シングルバイナリ生成による容易なデプロイが可能 |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| chi | v5.1.0 | HTTPルーティング | 軽量で標準ライブラリ互換、ミドルウェアサポート |
| gorm | v1.25.x | ORM | Go標準のORM、マイグレーション機能、MySQL対応 |
| slog | Go 1.21+ 標準 | 構造化ロギング | 標準ライブラリ、Google Cloud構造化ロギング対応 |
| google-uuid | v1.6.0 | UUID生成 | RFC 4122準拠、標準的なUUID実装 |
| cobra | v1.8.x | CLIフレームワーク | Go標準のCLIライブラリ、サブコマンド対応 |
| oapi-codegen | v2.4.x | OpenAPIコード生成 | OpenAPI 3.0からGoコードを自動生成 |

### 分散トレーシング

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| opentelemetry-go | v1.28.x | トレーシングSDK | 分散トレーシング標準、Cloud Trace連携 |
| otelhttp | v0.53.x | HTTPインストルメンテーション | 自動スパン生成、W3C TraceContext伝搬 |
| otlptracegrpc | v1.28.x | OTLPエクスポーター | Cloud TraceへのgRPCエクスポート |

### データベース

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Cloud SQL (MySQL) | 8.4 | 暗号化DEKの永続化 | マネージドRDBMS、トランザクション対応、高可用性 |

### デプロイ先のクラウドサービス

| 技術 | 用途 | 選定理由 |
|------|------|----------|
| Cloud Run | APIサーバー実行環境 | サーバーレス、自動スケーリング、HTTPSエンドポイント自動提供 |

### 連携先外部サービス

| 技術 | 用途 | 選定理由 |
|------|------|----------|
| Cloud KMS | DEKの暗号化/復号（KEK管理） | マネージド鍵管理、エンベロープ暗号化パターンの実現 |
| Cloud Logging | 監査ログ保存 | マネージドログ管理、PCI-DSS対応 |
| Cloud Trace | 分散トレーシング | APMモニタリング、レイテンシ分析 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Docker | 27.x | コンテナビルド | Cloud Runデプロイ用コンテナイメージ作成 |
| golangci-lint | v1.61.x | 静的解析 | コード品質維持、CI/CD統合 |
| go test | Go 標準 | テスト実行 | 標準テストフレームワーク |
| testcontainers-go | v0.34.x | 統合テスト | MySQL/KMSエミュレータのコンテナ化テスト |

## アーキテクチャパターン

### レイヤードアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      CLIレイヤー (keyctl)                    │
│  - コマンドライン引数のパース                                  │
│  - 入力値のバリデーション                                      │
│  - トレースコンテキスト生成・伝播                               │
│  - REST APIの呼び出し                                         │
├─────────────────────────────────────────────────────────────┤
│                    APIレイヤー (REST API Server)              │
│  - HTTPリクエストの受付とルーティング                          │
│  - トレースコンテキスト抽出・伝播                               │
│  - リクエストのバリデーション                                   │
│  - 監査ログ出力                                               │
├─────────────────────────────────────────────────────────────┤
│                   サービスレイヤー (KeyService)               │
│  - ビジネスロジック（鍵生成、ローテーション等）                  │
│  - Cloud KMSとの連携（暗号化/復号）                            │
├─────────────────────────────────────────────────────────────┤
│                   データレイヤー (KeyRepository)              │
│  - Cloud SQLへのCRUD操作                                      │
│  - gormによるトランザクション管理                               │
└─────────────────────────────────────────────────────────────┘
```

#### CLIレイヤー (keyctl)

- **責務**: ユーザー入力の受付、バリデーション、API呼び出し、結果の表示、トレースコンテキスト生成
- **許可される操作**: APIレイヤー（REST API）の呼び出し
- **禁止される操作**: サービスレイヤー・データレイヤーへの直接アクセス

#### APIレイヤー (REST API Server)

- **責務**: HTTPリクエストの受付、バリデーション、サービス呼び出し、レスポンス返却、監査ログ出力
- **許可される操作**: サービスレイヤーの呼び出し
- **禁止される操作**: データレイヤーへの直接アクセス

#### サービスレイヤー (KeyService)

- **責務**: ビジネスロジックの実装、Cloud KMS連携、データ変換
- **許可される操作**: データレイヤーの呼び出し、Cloud KMS APIの呼び出し
- **禁止される操作**: APIレイヤーへの依存

#### データレイヤー (KeyRepository)

- **責務**: データの永続化、取得
- **許可される操作**: Cloud SQL（MySQL）へのアクセス
- **禁止される操作**: ビジネスロジックの実装

### 依存関係の方向

```
CLI → API → Service → Repository → Cloud SQL
                 ↓
             Cloud KMS
```

## データ永続化戦略

### データの永続化方法

- **暗号化DEK**: Cloud SQL (MySQL 8.4) に保存
- **DEKの暗号化**: Cloud KMSのKEKで暗号化した状態で保存
- **トランザクション**: gormのトランザクション機能を使用

### バックアップ戦略

- **頻度**: Cloud SQLの自動バックアップ機能を使用（日次）
- **保存先**: Cloud SQL自動バックアップ（同一リージョン）
- **世代管理**: 7日間保持（Cloud SQL標準設定）
- **復元方法**: Cloud SQLコンソールまたはgcloudコマンドでポイントインタイムリカバリ

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定方法 |
|------|---------|---------|
| API全操作 | 1000ms以内（p99） | OpenTelemetryスパンのduration |
| CLIコマンド | 2000ms以内 | コマンド実行開始から終了まで |

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| Cloud Runメモリ | 512MB | 鍵管理の処理に十分、コスト最適化 |
| Cloud Run CPU | 1 vCPU | 暗号化処理に十分 |
| Cloud SQL接続数 | 100 | Cloud Run最大インスタンス数 × 接続数を考慮 |

### 測定環境

```
測定環境:
- Cloud Run: 512MB メモリ、1 vCPU
- Cloud SQL: db-f1-micro（開発）/ db-n1-standard-1（本番）
- リージョン: asia-northeast1

測定方法:
- OpenTelemetryによるスパン計測
- Cloud Trace でレイテンシ分析
- 負荷テストはk6を使用
```

## セキュリティアーキテクチャ

### データ保護

| 対象 | 保護方式 |
|------|----------|
| DEK（保存時） | Cloud KMSのKEKで暗号化してCloud SQLに保存 |
| DEK（転送時） | HTTPS（TLS 1.2以上）で暗号化 |
| Cloud SQL接続 | Cloud SQL Proxy経由のSSL接続 |

### 入力検証

| 検証項目 | 方法 |
|----------|------|
| tenant_id | 正規表現 `^[a-zA-Z0-9_-]+$`、1-64文字 |
| generation | 正の整数（1以上） |
| リクエストサイズ | 最大1MB（Cloud Run標準） |

### OWASP Top 10対策

| 脆弱性カテゴリ | 対策 |
|---------------|------|
| A01: アクセス制御の不備 | Google Cloud IAMで認証・認可を実装 |
| A02: 暗号化の失敗 | AES-256、Cloud KMSによるエンベロープ暗号化 |
| A03: インジェクション | gormのプリペアドステートメント使用 |
| A04: 安全でない設計 | レイヤードアーキテクチャで責務分離 |
| A05: セキュリティ設定ミス | 環境変数による設定、シークレットマネージャー使用 |
| A09: ロギングと監視の不備 | 全操作の監査ログ出力、Cloud Trace連携 |

### 機密情報管理

| 情報 | 管理方法 |
|------|----------|
| KMS_KEY_NAME | 環境変数（Cloud Run設定） |
| DB接続文字列 | Secret Manager + 環境変数 |
| サービスアカウントキー | Workload Identity（キーレス認証） |

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**: 10,000テナント × 100世代 = 100万レコード
- **パフォーマンス劣化対策**:
  - tenant_id, generationへの複合インデックス
  - Cloud SQLの垂直スケーリング
- **アーカイブ戦略**: 現時点では不要（論理削除で対応）

### 負荷増加への対応

- **Cloud Runスケーリング**: 最小0、最大10インスタンス（初期設定）
- **コネクションプール**: gormの接続プール設定
  - MaxOpenConns: 10
  - MaxIdleConns: 5
  - ConnMaxLifetime: 30分

### 機能拡張性

- **APIバージョニング**: URLパスに `/v1/` を含め、将来のバージョンアップに対応
- **設定のカスタマイズ**: 環境変数による設定外部化

## テスト戦略

### ユニットテスト

- **フレームワーク**: go test（標準）
- **対象**:
  - KeyService: 鍵生成ロジック、ビジネスルール検証
  - KeyRepository: クエリ生成、エラーハンドリング
  - CLI: 引数パース、出力フォーマット
- **カバレッジ目標**: 80%以上

### 統合テスト・E2Eテスト

Cloud KMSはエミュレータが提供されていないため、統合テスト以降はGoogle Cloud環境にデプロイして検証する。

- **環境**: Google Cloud（開発環境プロジェクト）
- **方法**: Cloud Runにデプロイし、実際のCloud KMS/Cloud SQLと連携してテスト
- **対象**:
  - API + Service + Repository の結合テスト
  - KMS暗号化/復号の動作確認
  - トレーシングスパンの検証
- **E2Eシナリオ**:
  - 鍵生成 → 取得 → ローテーション → 無効化の一連のフロー
  - 複数テナントでの並行操作
  - エラーケース（存在しないテナント、重複生成等）
  - CLI → API → DB の一連のフロー

## 技術的制約

### 環境要件

- **OS**: Linux（Cloud Run）
- **Go バージョン**: 1.23以上
- **必要な外部依存**:
  - Cloud SQL（MySQL 8.4）
  - Cloud KMS
  - Cloud Run
  - Cloud Logging
  - Cloud Trace

### パフォーマンス制約

- Cloud KMS API呼び出しレイテンシ: 50-200ms（リージョン内）
- Cloud SQL接続確立: 初回100-500ms（コネクションプールで軽減）

### セキュリティ制約

- DEKの平文をログに出力しない
- DEKの平文をメモリに長時間保持しない（使用後即座にゼロクリア推奨）
- Cloud KMS以外での鍵暗号化は禁止

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| chi | HTTPルーティング | メジャーバージョン固定（v5.x） |
| gorm | ORM | メジャーバージョン固定（v1.x） |
| opentelemetry-go | トレーシング | マイナーバージョン追従 |
| cobra | CLI | メジャーバージョン固定（v1.x） |
| cloud.google.com/go | GCP SDK | マイナーバージョン追従 |

### バージョン更新方針

- **セキュリティパッチ**: 即座に適用
- **マイナーバージョン**: 月次で評価・更新
- **メジャーバージョン**: 四半期ごとに評価、計画的に移行

## 環境変数一覧

| 変数名 | 必須 | 説明 | 例 |
|--------|------|------|-----|
| KMS_KEY_NAME | 必須 | Cloud KMSの暗号鍵リソース名 | projects/my-project/locations/asia-northeast1/keyRings/my-keyring/cryptoKeys/my-key |
| DATABASE_URL | 必須 | Cloud SQL接続文字列 | user:password@tcp(localhost:3306)/keydb?parseTime=true |
| OTEL_ENABLED | 任意 | OpenTelemetryの有効化（デフォルト: false） | true / false |
| OTEL_EXPORTER_OTLP_ENDPOINT | 任意 | OTLPエクスポート先（OTEL_ENABLED=true時に必須） | https://cloudtrace.googleapis.com |
| OTEL_SERVICE_NAME | 任意 | サービス名（デフォルト: key-management-service） | key-management-service |
| OTEL_SAMPLING_RATE | 任意 | サンプリング率 0.0〜1.0（デフォルト: 1.0） | 0.1 |
| GOOGLE_CLOUD_PROJECT | 必須 | GCPプロジェクトID | my-project-id |
| PORT | 任意 | APIサーバーポート（デフォルト: 8080） | 8080 |
| LOG_LEVEL | 任意 | ログレベル（デフォルト: INFO） | DEBUG / INFO / WARN / ERROR |
